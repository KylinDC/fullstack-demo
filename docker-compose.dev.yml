# Development docker-compose with hot reload and SQLite
version: '3.8'

services:
  backend:
    image: node:22-alpine
    container_name: fullstack-demo-backend-dev
    working_dir: /app/apps/backend
    command: sh -c "corepack enable && corepack prepare pnpm@9.0.0 --activate && pnpm install && pnpm dev:node"
    environment:
      NODE_ENV: development
      PORT: 3000
    ports:
      - '3000:3000'
    volumes:
      # Mount entire workspace for hot reload
      - ./:/app
      # Persist SQLite database
      - sqlite_data_dev:/app/apps/backend/.wrangler/state/v3/d1/miniflare-D1DatabaseObject
      # Exclude node_modules to avoid conflicts
      - /app/node_modules
      - /app/apps/backend/node_modules
      - /app/apps/frontend/node_modules

  frontend:
    image: node:22-alpine
    container_name: fullstack-demo-frontend-dev
    working_dir: /app/apps/frontend
    command: sh -c "corepack enable && corepack prepare pnpm@9.0.0 --activate && pnpm install && pnpm dev --host"
    environment:
      VITE_API_URL: http://localhost:3000
    ports:
      - '5173:5173'
    volumes:
      - ./:/app
      - /app/node_modules
      - /app/apps/backend/node_modules
      - /app/apps/frontend/node_modules
    depends_on:
      - backend

volumes:
  sqlite_data_dev:

